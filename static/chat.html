<script>
document.addEventListener('DOMContentLoaded', () => {
  (async () => {
    // Backends
    const API_BASE = 'https://employees-board-diagnostic-thee.trycloudflare.com';
    const WS_BASE  = 'wss://employees-board-diagnostic-thee.trycloudflare.com';

    // Session
    const reg_no = sessionStorage.getItem('reg_no');
    const name   = sessionStorage.getItem('name');
    if (!reg_no || !name){ location.href = '/'; return; }

    // DOM refs
    const who = document.getElementById('who');
    const statusEl = document.getElementById('status');
    const chat = document.getElementById('chat');
    const qEl = document.getElementById('q');
    const sendBtn = document.getElementById('send');
    const micBtn = document.getElementById('mic');
    const logoutBtn = document.getElementById('logout');
    const stopBtn = document.getElementById('stopSpeech');

    who.textContent = `Logged in as ${name} (${reg_no})`;

    // ----- TTS controller code here (ensureVoice, ttsStartNewAnswer, etc.) -----
    // Keep your existing TTS functions exactly as before.

    await ensureVoice(); // awaited safely inside async IIFE

    // WebSocket
    let ws = null;
    function connectWS(){
      ws = new WebSocket(`${WS_BASE}/ws/chat`);
      ws.onopen = ()=> statusEl.textContent = 'WS connected';
      ws.onclose = ()=> statusEl.textContent = 'WS closed';
      ws.onerror = ()=> statusEl.textContent = 'WS error';
      ws.onmessage = (ev)=>{
        try{
          const m = JSON.parse(ev.data);
          if (m.event === 'token'){
            const last = chat.lastElementChild;
            if (last && last.classList.contains('assistant')){
              last.querySelector('.bubble').textContent += m.text;
            } else {
              addMsg('assistant', m.text);
            }
            ttsOnToken(m.text);
          } else if (m.event === 'done'){
            ttsDone();
          } else if (m.event === 'error'){
            addMsg('assistant', `Error: ${m.text}`);
          }
        }catch{}
      };
    }
    connectWS();

    // Greeting
    ttsStartNewAnswer();
    const welcome = `Welcome, ${name}. How can I help you today?`;
    addMsg('assistant', welcome);
    ttsOnToken(welcome); ttsDone();

    // Send
    function sendPrompt(text){
      if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
      addMsg('user', text);
      addMsg('assistant', '');
      ttsStartNewAnswer();
      ws.send(JSON.stringify({ reg_no, content: text, model: 'llama-3.2-3b-instruct' }));
    }
    sendBtn.addEventListener('click', ()=>{ const t=qEl.value.trim(); sendPrompt(t); qEl.value=''; });
    qEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ sendBtn.click(); } });

    // Mic
    let rec=null, chunks=[];
    micBtn.addEventListener('mousedown', async ()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        rec = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = async ()=>{
          try{
            const blob = new Blob(chunks, { type:'audio/webm' });
            const fd = new FormData(); fd.append('file', blob, 'audio.webm');
            const j = await fetch(`${API_BASE}/api/transcribe`, { method:'POST', body: fd }).then(r=>r.json());
            if (j.text){ qEl.value = j.text; sendBtn.click(); }
          }catch(e){}
        };
        rec.start(300);
      }catch(e){}
    });
    function stopRec(){ if (rec && rec.state==='recording') rec.stop(); rec=null; }
    micBtn.addEventListener('mouseup', stopRec);
    micBtn.addEventListener('mouseleave', stopRec);
    micBtn.addEventListener('touchstart',(e)=>{ e.preventDefault(); micBtn.dispatchEvent(new Event('mousedown')); }, {passive:false});
    micBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); stopRec(); }, {passive:false});

    // Stop Speaking
    document.getElementById('stopSpeech').addEventListener('click', () => { ttsStopNow(); });

    // Logout
    logoutBtn.addEventListener('click', async ()=>{
      try{ await fetch(`${API_BASE}/api/logout`, { method:'POST' }); }catch(e){}
      sessionStorage.removeItem('reg_no'); sessionStorage.removeItem('name'); sessionStorage.removeItem('voice_name');
      if (ws){ ws.close(); }
      location.href = '/';
    });
  })();
});
</script>
